---
title: Deploy Teleport Agents with Terraform
description: Learn how to use Terraform to deploy Teleport Agents and protect resources in your infrastructure.
---

An Agent is a Teleport instance configured to run one or more Teleport services
in order to proxy infrastructure resources. For a brief architectural overview
of how Agents run in a Teleport cluster, read the [Introduction to Teleport
Agents](introduction.mdx).

This guide shows you how to deploy a pool of Teleport Agents running on virtual
machines by declaring it as code using Terraform.

There are several methods you can use to join a Teleport Agent to your cluster,
which we discuss in the [Joining Services to your
Cluster](join-services-to-your-cluster.mdx) guide. In this guide, we will use
the **join token** method, where the operator stores a secure token on the Auth
Service, and an Agent presents the token in order to join a cluster.

No matter which join method you use, it will involve the following Terraform
resources:

- Compute instances to run Teleport services
- A join token for each compute instance in the agent pool

![A Teleport Agent pool](../../img/tf-agent-diagram.png)

## Prerequisites

(!docs/pages/includes/edition-prereqs-tabs.mdx!)

<Admonition type="tip">

We recommend following this guide on a fresh Teleport demo cluster so you can
see how an agent pool works. After you are familiar with the setup, apply the
lessons from this guide to protect your infrastructure. You can get started with
a demo cluster using:
- A demo deployment on a [Linux server](../index.mdx)
- A [Teleport Enterprise Cloud trial](https://goteleport.com/signup)

</Admonition>

- An AWS, Google Cloud, or Azure account with permissions to create virtual
  machine instances.
  
- Cloud infrastructure that enables virtual machine instances to connect to the
  Teleport Proxy Service. For example:
  - An AWS subnet with a public NAT gateway or NAT instance.
  - Google Cloud NAT
  - Azure NAT Gateway

  In minimum-security demo clusters, you can also configure the VM instances you
  deploy to have public IP addresses.

- Terraform v(=terraform.version=) or higher.

- An identity file for the Teleport Terraform provider. Make sure you are
  familiar with [how to set up the Teleport Terraform
  provider](../management/dynamic-resources/terraform-provider.mdx) before
  following this guide.

- (!docs/pages/includes/tctl.mdx!)

## Step 1/6. Set up a module for deploying Agents

1. Navigate to a directory where you would like to place the root Terraform
   module that manages Teleport resources.
1. Create a file called `main.tf` with the following content:

   <Tabs>
   <TabItem label="AWS">
   
   ```hcl
   module "teleport" {
     source                = "${module.root}/teleport"
     agent_count           = 2
     agent_roles           = ["Node"]
     proxy_service_address = "teleport.example.com:443"
     teleport_edition      = "oss"
     teleport_version      = "(=teleport.version=)"
   }
   
   module "agents" {
     region           = ""
     source           = "${module.root}/cloud"
     subnet_id        = ""
     userdata_scripts = module.teleport.userdata_scripts
   }
   ```
   
   </TabItem>
   <TabItem label="Google Cloud">
   
   ```hcl
   module "teleport" {
     source                = "${module.root}/teleport"
     agent_count           = 2
     agent_roles           = ["Node"]
     proxy_service_address = "teleport.example.com:443"
     teleport_edition      = "oss"
     teleport_version      = "(=teleport.version=)"
   }
   
   module "agents" {
     gcp_zone         = "us-east1-b"
     google_project   = ""
     source           = "${module.root}/cloud"
     subnet_id        = ""
     userdata_scripts = module.teleport.userdata_scripts
   }
   ```
   
   </TabItem>
   <TabItem label="Azure">
   
   ```hcl
   module "teleport" {
     source                = "${module.root}/teleport"
     agent_count           = 2
     agent_roles           = ["Node"]
     proxy_service_address = "teleport.example.com:443"
     teleport_edition      = "oss"
     teleport_version      = "(=teleport.version=)"
   }
   
   module "agents" {
     azure_resource_group = ""
     public_key_path      = ""
     region               = "East US"
     source               = "${module.root}/cloud"
     subnet_id            = ""
     userdata_scripts     = module.teleport.userdata_scripts
   }
   ```
   
   </TabItem>
   </Tabs>

1. Create two directories inside your root module directory:

   |Directory|Purpose|
   |---|---|
   |`teleport`|Dynamic Teleport resources to apply against the Teleport Auth Service using the Teleport Terraform provider.|
   |`cloud`|Resources required to run your Teleport Agents as Linux servers using your cloud provider.| 

## Step 3/6. Create resources for your cloud provider

In Step 3, you will define resources to deploy Teleport Agents on a pool of
Linux servers using the Terraform provider for your cloud.

### Configure the Terraform provider for your cloud

1. Navigate to the `cloud` dorectory you created in the previous step.

1. Follow the remaining instructions in this section based on your cloud
   provider. In the `cloud` directory, create a file called
   `required_providers.tf` with the following content:

  <Tabs>
  <TabItem label="AWS">

  ```hcl 
  (!examples/agent-pool-terraform/aws/required_providers.tf!)
  ```

  </TabItem>
  <TabItem label="Google Cloud">

  ```hcl 
  (!examples/agent-pool-terraform/gcp/required_providers.tf!)
  ```

  </TabItem>
  <TabItem label="Azure">

  ```hcl 
  (!examples/agent-pool-terraform//azure/required_providers.tf!)
  ```

  </TabItem>
  </Tabs>

### Configure Linux servers to run Agents

Create a file called `ec2-instance.tf` in the `cloud` directory and add the
following HCL configuration, depending on your cloud provider. The configuration
declares compute instances to that run Teleport Agents using a join token:

<Tabs>
<TabItem label="AWS">

Declare a data source for an Amazon Linux 2023 machine image and uses it to
launch EC2 instances that run Teleport agents with the
`teleport_provision_token` resource:

```hcl 
(!examples/agent-pool-terraform/aws/ec2-instance.tf!)
```

</TabItem>
<TabItem label="Google Cloud">

Declare Google Compute Engine instances that use the
`teleport_provision_token` to run Teleport agents:

```hcl 
(!examples/agent-pool-terraform/gcp/gcp-instance.tf!)
```

</TabItem>
<TabItem label="Azure">

```hcl 
(!examples/agent-pool-terraform/azure/azure-instance.tf!)
```

</TabItem>
</Tabs>

### Add a user data script

The configuration you created runs a user data script on each agent instance.
The services enabled by the configuration file depend on the value of the
`agent_roles` input variable. In the `teleport` directory, create a file called
`userdata` with the following content:

```hcl
(!examples/agent-pool-terraform/teleport/userdata!)
```

### Configure inputs

Earlier in this guide, we added `module` blocks to configure high-level settings
for the Agent deployment. Decalre input variables to make these settings
editable:

<Tabs>
<TabItem label="AWS">

```hcl 
(!examples/agent-pool-terraform/aws/inputs.tf!)
```

</TabItem>
<TabItem label="Google Cloud">

```hcl 
(!examples/agent-pool-terraform/gcp/inputs.tf!)
```

</TabItem>
<TabItem label="Azure">

```hcl 
(!examples/agent-pool-terraform/azure/inputs.tf!)
```
</TabItem>
</Tabs>

{/*TODO: Explain the input variables.*/}

## Step 4/6. Define dynamic resources

{/* TODO: Explain how the module works, e.g., it creates join tokens and
userdata scripts that include those join tokens*/}

### Make join tokens available to Teleport Agents

1. From your Terraform root module directory, navigate to the `teleport`
   directory.

1. Create a file called `required_providers.tf` with the following content,
   which requires the Teleport Terraform provider:

   ```hcl
   (!examples/agent-pool-terraform/teleport/required_providers.tf!)
   ```

1. Define input variables. These enable you to reconfigure the module at a high
   level, which we did earlier in this guide using `module` blocks:

   ```hcl
   (!examples/agent-pool-terraform/teleport/inputs.tf!)
   ```

   {/*TODO: Explain the input variables*/}

1. Declare a join token to create for each instance of the module. The compute
   instances declared earlier run a userdata script that makes this token
   available to each agent: 

   ```hcl
   (!examples/agent-pool-terraform/teleport/token.tf!)
   ```

1. Declare a userdata script that runs a new Teleport Agent using the join token
   created by each instance of the module. Make this an output so we can pass it
   to the `cloud` module:

   ```hcl
   (!examples/agent-pool-terraform/teleport/outputs.tf!)
   ```

### Enroll dynamic infrastructure resources

You can declare Terraform resources that enroll your infrastructure with
Teleport. The Teleport Terraform provider currently supports the following:

|Infrastructure Resource|Terraform Resource|
|---|---|
|Application|`teleport_app`|
|Database|`teleport_database`|

To declare a dynamic resource with Terraform, add a configuration block similar
to the ones below to a `*.tf` file in your `agent-pool-terraform` project
directory. 

The Teleport Terraform provider creates these on the Auth Service backend, and
the relevant Teleport services query them in order to proxy user traffic. For a
full list of supported resources and fields, see the [Terraform provider
reference](../reference/terraform-provider.mdx).

<Tabs>
<TabItem label="Application">

```hcl
resource "teleport_app" "example" {
  metadata = {
    name        = "example"
    description = "Test app"
    labels = {
      // Teleport adds this label by default, so add it here to
      // ensure a consistent state.
      "teleport.dev/origin" = "dynamic"
    }
  }

  spec = {
    uri = "localhost:3000"
  }
}
```

</TabItem>
<TabItem label="Database">

```hcl
resource "teleport_database" "example" {
  metadata = {
    name        = "example"
    description = "Test database"
    labels = {
      // Teleport adds this label by default, so add it here to
      // ensure a consistent state.
      "teleport.dev/origin" = "dynamic"
    }
  }

  spec = {
    protocol = "postgres"
    uri      = "localhost"
  }
}
```

</TabItem>
</Tabs>

## Step 5/5. Verify the deployment

Make sure your cloud provider credentials are available to Terraform using the
standard approach for your organization.

Apply the Terraform configuration:

```code
$ terraform init
$ terraform apply
```

Once the `apply` command completes, run the following command to verify that
your agents have deployed successfully. This command, which assumes that the
agents have the `Node` role, lists all Teleport SSH Service instances with the
`role=agent-pool` label:

```code
$ tsh ls role=agent-pool
Node Name                  Address    Labels
-------------------------- ---------- ---------------
ip-10-1-1-187.ec2.internal ⟵ Tunnel   role=agent-pool
ip-10-1-1-24.ec2.internal  ⟵ Tunnel   role=agent-pool
```

## Next step: Define static resources

Each Teleport service reads its local configuration file (`/etc/teleport.yaml`
by default) to determine which infrastructure resources to proxy. You can edit
this configuration file to enroll resources with Teleport.

In the setup we explored in this guide, you can edit the user data script for
each instance to add configuration settings to, for example, the
`database_service` or `kubernetes_service` sections.

To see how to configure each service, read its section of the documentation:

- [SSH Service](../server-access/introduction.mdx)
- [Database Service](../database-access/introduction.mdx)
- [Kubernetes Service](../kubernetes-access/introduction.mdx)
- [Windows Desktop Service](../desktop-access/introduction.mdx)
- [Application Service](../application-access/introduction.mdx)

